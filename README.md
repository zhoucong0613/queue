# ARGUS D1 双目相机客户端 SDK

## 1. SDK 简介

本 SDK 为**ARGUS_D1 双目相机**专属客户端程序，基于 TCP/IP 协议实现与相机服务端的稳定网络通信，原生支持 C/Python 双语言开发环境，未来将兼容 ROS 生态集成，专为机器人、SLAM、AR/VR、工业深度感知等高性能、高实时性场景设计。

SDK 核心实现 ARGUS_D1 相机多路同步数据流的全链路轻量化处理，覆盖网络接收、数据解析、可视化、导出及性能分析全流程，提供标准化可扩展接口，兼顾现场调试、算法验证与企业级生产部署需求，核心能力如下：

- 支持指定网口绑定，稳定接收四路同步数据流（左 / 右相机 YUV NV12、16 位灰度深度图、三轴 IMU），严格保证时序一致性；
- 实现 16 位深度图到 XYZ 三维点云的高精度转换，内置相机参数原生适配逻辑；
- 提供多窗口实时预览，深度图支持 Jet 伪彩色 / 灰度双模式，相机影像支持 NV12 转 BGR 可视化；
- 集成轻量级性能统计模块，量化核心流程耗时与处理帧率，辅助瓶颈定位；
- 支持按位配置日志粒度与数据导出类型，实现精细化调试，保留相机原生数据特征。

本 SDK 可直接应用于机器人环境感知、SLAM 建图、AR/VR 空间交互、工业视觉深度检测等实际业务场景。

## 2.SDK框架

### 2.1 SDK目录

```shell
.
├── include/          # ⭐ SDK 对外接口头文件
├── src/              # ⭐ SDK 核心实现（网络 / 队列 / 协议 / 渲染）
├── main.c            # ⭐ C 版本参考 Client（标准生产者消费者模型）
├── wrapper.cpp       # ⭐ pybind11：Python Binding
├── python/           # ⭐ Python 客户端 & 可视化工具
├── Makefile          
├── lib/              # (make 生成) 动态库输出目录
├── test.sh           # ⭐ 运行 C Client
├── run.sh            # ⭐ 运行 Python Client
└── README.md
```

### 2.2 SDK架构

```shell
┌──────────────────────────────────────────────────────────────┐
│                        Python Layer                         │
│  python/stereo_client.py  /  stereo_render.py              │
│                                                            │
│  • 快速调试 / 可视化 / Dump / 算法验证                      │
│  • 完整复刻 C Client 行为                                   │
│  • 基于 memoryview 的零拷贝数据访问                         │
└───────────────────────────────▲──────────────────────────────┘
                                │  pybind11
┌───────────────────────────────┴──────────────────────────────┐
│                        C++ Wrapper                          │
│                         wrapper.cpp                         │
│                                                            │
│  • 将 C SDK 暴露为 Python 模块 (stereo_client_py.so)       │
│  • memoryview / numpy 零拷贝                                │
│  • 类型安全的结构体映射                                     │
└───────────────────────────────▲──────────────────────────────┘
                                │
┌───────────────────────────────┴──────────────────────────────┐
│                         C SDK Core                          │
│                                                            │
│  include/ + src/                                           │
│                                                            │
│  • stereo_client.c        → 网络协议 / 数据帧拼接           │
│  • synchronous_queue.c    → 高性能生产者消费者队列          │
│  • render_depth.cpp       → 深度图渲染加速                  │
│  • eeprom_calib / imu     → 标定 & IMU 数据结构             │
│  • performance_test_util  → 性能统计                        │
└───────────────────────────────▲──────────────────────────────┘
                                │  SDK API
                                │
                    ┌───────────┴───────────┐
                    ▼                       ▼
             main.c (C Reference Client)   Python Client
             consumer_process()            (等价逻辑)
```

### 2.3 C client架构

```
                   Stereo Device
                        │  Ethernet / USB
                        ▼
               stereo_client_recv_data()
                        │
                        ▼
               synchronous_queue (Buffer Pool)
                        │
            ┌───────────┴────────────┐
            ▼                        ▼
     client_recv_data()       consumer_process()
     (Producer Thread)        (Consumer Thread)
                                     │
                                     ▼
                        client_get_buffer_size_by_type()
                                     │
        ┌───────────────┬───────────────┬───────────────┬───────────────┐
        ▼               ▼               ▼               ▼
      Depth            Left            Right            IMU
        │               │               │               │
        ▼               ▼               ▼               ▼
 Render / Cloud     NV12 Preview     NV12 Preview    Parse/Print
 Dump / Verbose     Dump             Dump
```

## 3 系统与环境依赖

### 3.1 操作系统
- **Linux 系统**
  - 官方测试平台：Ubuntu 20.04

### 3.2 硬件接口
- **USB 3.0 转以太网接口**
  -  必须使用 **USB 3.0 接口线**，以保证带宽和稳定性
  - 系统识别为网络接口，例如 `usb0` 或 `ethX`
  - 建议设置最大 MTU 为 **9000**，以提升数据吞吐量
  - 确保设备与服务器在同一网段，保证数据传输稳定

### 3.3 内核驱动
- **CDC Ethernet 驱动**
  
  - 驱动：`cdc_ether.ko`
  
  - 驱动安装方式：
  
    ```shell
    sudo apt install linux-modules-extra-$(uname -r) -y
    ```
  
  - 加载方式：
    ```shell
    sudo modprobe cdc_ether
    ```
    
  - 检查驱动是否已加载：
  
    ```shell
    lsmod | grep cdc_ether
    ```

### 3.4 网络配置

- **网口固定命名**（执行完之后需要重新插拔相机，网口名称会被识别成usb0）

  ```shell
  echo 'SUBSYSTEM=="net", ACTION=="add", ATTRS{idVendor}=="0525", ATTRS{idProduct}=="a4a2", NAME="usb0"' | sudo tee /etc/udev/rules.d/10-rename-usb-net.rules
  sudo udevadm control --reload-rules && sudo udevadm trigger
  ```

- **usb0 静态 IP 配置**（相机服务端ip：192.168.5.5，usb0网口需要配置在同一网段）

  ```shell
  sudo ifconfig usb0 192.168.5.10
  sudo ifconfig usb0 mtu 9000
  ```

- **网络检测**

  ```shell
  ping 192.168.5.5
  ```

## 4.编译

### 4.1常规编译

```shell
make #进入sdk根目录
```

### 4.2交叉编译

- 交叉编译需要根据**makefile**自行修改配置

## 5.启动说明

### 5.1 C client参数说明

#### 5.1.1 核心参数列表

| 短参数 |    长参数     | 参数类型 | 必选 / 可选 | 默认值 |                             说明                             |
| :----: | :-----------: | :------: | :---------: | :----: | :----------------------------------------------------------: |
|  `-i`  | `--interface` |  字符串  |    必选     |   无   |       指定绑定的网络接口，需与相机网口一致（如`usb0`）       |
|  `-s`  |  `--server`   |  字符串  |    必选     |   无   |        ARGUS_D1 相机服务端 IP 地址（如`192.168.5.5`）        |
|  `-v`  |  `--verbose`  |   整数   |    可选     |   0    | 日志输出模式，**按位标志组合**（多模式相加，0 为关闭所有日志） |
|  `-d`  |   `--dump`    |   整数   |    可选     |   0    | 数据导出模式，**按位标志组合**（多模式相加，0 为关闭所有导出） |
|  `-p`  |  `--preview`  |   整数   |    可选     |   0    | 实时预览模式，**按位标志组合**（多模式相加，0 为关闭所有预览） |
|  `-m`  |   `--mode`    |   整数   |    可选     |   1    | 相机工作模式，1 = 输出矫正后左右双目图，2=输出未矫正后左右双目图 |

#### 5.1.2 按位标志详细说明

##### 日志模式（-v/--verbose）

| 数值 |        对应宏定义        |                   说明                    |
| :--: | :----------------------: | :---------------------------------------: |
|  1   |      VERBOSE_STREAM      |    打印网络流头校验、数据接收基础日志     |
|  2   |   VERBOSE_LR_RAW_NV12    | 打印左 / 右相机 NV12 数据时间戳、大小信息 |
|  4   | VERBOSE_DEPTH_POINTCLOUD |     打印深度图信息、点云转换核心日志      |
|  8   |       VERBOSE_IMU        |    打印 IMU 三轴加速度、陀螺仪原始数值    |

> 示例：`-v 5` = 1+4，同时开启流头日志 + 深度点云日志

##### 预览模式（-p/--preview）

| 数值 |  对应宏定义   |                  说明                   |
| :--: | :-----------: | :-------------------------------------: |
|  1   | PREVIEW_DEPTH | 开启深度图实时预览（Jet 伪彩色 + 灰度） |
|  2   | PREVIEW_LEFT  |   开启左相机影像实时预览（NV12→BGR）    |
|  4   | PREVIEW_RIGHT |   开启右相机影像实时预览（NV12→BGR）    |

> 示例：`-p 7` = 1+2+4，同时开启深度 + 左相机 + 右相机预览

##### 导出模式（-d/--dump）

每 10 帧周期性导出，保留相机原生数据格式，**支持点云导出**为 TXT 格式（C++ 版独有）：

| 数值 |      对应宏定义      |                  说明                  |
| :--: | :------------------: | :------------------------------------: |
|  1   |   DUMP_LR_RAW_NV12   | 导出左 / 右相机原始 NV12 数据（.yuv）  |
|  2   |   DUMP_DEPTH_FILE    |  导出 16 位灰度深度图原始数据（.bin）  |
|  4   | DUMP_POINTCLOUD_FILE | 导出深度图转换后的三维点云数据（.txt） |

> 示例：`-d 7` = 1+2+4，同时导出 NV12 + 深度 + 点云数据

#### 5.1.3 C快速启动示例

```shell
export LD_LIBRARY_PATH=./lib:$LD_LIBRARY_PATH
export PYTHONPATH=./lib:$PYTHONPATH
```

```shell
# 基础启动：usb0绑定，连接相机192.168.5.5，开启深度预览
./stereo_client -i usb0 -s 192.168.5.5 -p 1 -m 1
# 全功能启动：开启所有预览+导出深度/点云+打印IMU日志
./stereo_client -i usb0 -s 192.168.5.5 -p 7 -d 6 -v 8 -m 1
```

### 5.2 Python 运行参数说明

#### 5.2.1 核心参数列表

| 短参数 |    长参数     | 参数类型 | 必选 / 可选 | 默认值 |                             说明                             |
| :----: | :-----------: | :------: | :---------: | :----: | :----------------------------------------------------------: |
|  `-i`  | `--interface` |  字符串  |    必选     |   无   |       指定绑定的网络接口，需与相机网口一致（如`usb0`）       |
|  `-s`  |  `--server`   |  字符串  |    必选     |   无   |        ARGUS_D1 相机服务端 IP 地址（如`192.168.5.5`）        |
|  `-v`  |  `--verbose`  |   整数   |    可选     |   0    |                日志输出模式，**按位标志组合**                |
|  `-d`  |   `--dump`    |   整数   |    可选     |   0    |                数据导出模式，**按位标志组合**                |
|  `-p`  |  `--preview`  |   整数   |    可选     |   0    |                实时预览模式，**按位标志组合**                |
|  `-m`  |   `--mode`    |   整数   |    可选     |   1    | 相机工作模式，1 = 输出矫正后左右双目图，2=输出未矫正后左右双目图 |
|  `-h`  |   `--help`    |    无    |    可选     |   -    |         查看 Python 版详细帮助（含位标志说明、示例）         |

#### 5.2.2 按位标志详细说明

##### 日志模式（-v/--verbose）/ 预览模式（-p/--preview）

##### 导出模式（-d/--dump）

每 10 帧周期性导出，**暂不支持点云导出**：

| 数值 |     对应常量     |                 说明                  |
| :--: | :--------------: | :-----------------------------------: |
|  1   | DUMP_LR_RAW_NV12 | 导出左 / 右相机原始 NV12 数据（.yuv） |
|  2   | DUMP_DEPTH_FILE  | 导出 16 位灰度深度图原始数据（.bin）  |

> 示例：`-d 3` = 1+2，同时导出 NV12 原始数据 + 深度二进制数据。

#### 5.2.3 Python 版快速启动示例

```shell
export LD_LIBRARY_PATH=./lib:$LD_LIBRARY_PATH
export PYTHONPATH=./lib:$PYTHONPATH
```

```
# 基础启动：usb0绑定，连接相机192.168.5.5，开启深度预览
python3 python/stereo_client.py -i usb0 -s 192.168.5.5 -m 1 -p 1
# 全功能启动：开启所有预览+导出NV12/深度+打印IMU日志，查看帮助
python3 python/stereo_client.py -i usb0 -s 192.168.5.5 -p 7 -d 3 -v 8 -m 1
```

## 6.故障排查

### 6.1 常见问题与解决方案

| 问题现象                  | 可能原因                                                 | 解决方案     |
| ------------------------- | :------------------------------------------------------- | ------------ |
| 出现画面明显卡顿/掉帧现象 | 相机上电情况下客户端程序重启次数太多，导致服务器缓存增多 | 断电重启相机 |